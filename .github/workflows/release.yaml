name: Release Charts

on:
  push:
    branches:
      - master
    paths:
      - '*/Chart.yaml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed charts
        id: detect
        run: |
          # Get all Chart.yaml files that changed in this push
          changed_files=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }} || git diff --name-only HEAD~1 HEAD)

          charts_json="[]"
          charts_list=""

          for file in $changed_files; do
            if [[ "$file" == */Chart.yaml ]] && [[ "$file" != *"/charts/"* ]] && [[ "$file" != *"/.github/"* ]]; then
              chart_dir=$(dirname "$file")
              chart_name=$(basename "$chart_dir")
              version=$(grep '^version:' "$file" | awk '{print $2}' | tr -d '"')

              echo "Detected chart: $chart_name (version: $version)"

              charts_json=$(echo "$charts_json" | jq -c ". + [{\"name\": \"$chart_name\", \"path\": \"$chart_dir\", \"version\": \"$version\"}]")
              charts_list="$charts_list $chart_name"
            fi
          done

          if [ "$(echo "$charts_json" | jq 'length')" -eq 0 ]; then
            echo "No charts changed"
            echo "charts=[]" >> "$GITHUB_OUTPUT"
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
          else
            echo "charts=$charts_json" >> "$GITHUB_OUTPUT"
            echo "matrix={\"include\":$charts_json}" >> "$GITHUB_OUTPUT"
            echo "Changed charts:$charts_list"
          fi

  release:
    needs: detect-changes
    if: needs.detect-changes.outputs.charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Check if version exists
        id: check-version
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"
          TAG="${CHART_NAME}-${VERSION}"

          if git tag | grep -q "^${TAG}$"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "⚠️  Version $VERSION for $CHART_NAME already released"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "✓ Version $VERSION for $CHART_NAME is new"
          fi

      - name: Lint chart
        if: steps.check-version.outputs.exists == 'false'
        run: |
          helm lint "${{ matrix.path }}"

      - name: Package chart
        if: steps.check-version.outputs.exists == 'false'
        run: |
          mkdir -p .cr-release-packages
          helm package "${{ matrix.path }}" --destination .cr-release-packages

      - name: Generate changelog
        if: steps.check-version.outputs.exists == 'false'
        id: changelog
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"
          CHART_PATH="${{ matrix.path }}"
          PREV_TAG=$(git tag --sort=-v:refname | grep "^${CHART_NAME}-" | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            CHANGES="Initial release of ${CHART_NAME} v${VERSION}"
          else
            echo "Generating changelog from $PREV_TAG to HEAD for $CHART_PATH"
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges -- "$CHART_PATH/" || echo "- Version bump to ${VERSION}")
            if [ -z "$CHANGES" ]; then
              CHANGES="- Version bump to ${VERSION}"
            fi
          fi

          # Create changelog file
          cat > .cr-release-packages/CHANGELOG.md << EOF
          # ${CHART_NAME} ${VERSION}

          ## Changes

          ${CHANGES}

          ## Installation

          \`\`\`bash
          helm repo add cabrera-evil https://cabrera-evil.github.io/charts/
          helm repo update
          helm install my-release cabrera-evil/${CHART_NAME} --version ${VERSION}
          \`\`\`

          ## Upgrading

          \`\`\`bash
          helm upgrade my-release cabrera-evil/${CHART_NAME} --version ${VERSION}
          \`\`\`
          EOF

          cat .cr-release-packages/CHANGELOG.md

      - name: Create GitHub Release
        if: steps.check-version.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"
          TAG="${CHART_NAME}-${VERSION}"

          gh release create "$TAG" \
            --title "${CHART_NAME} ${VERSION}" \
            --notes-file .cr-release-packages/CHANGELOG.md \
            .cr-release-packages/${CHART_NAME}-${VERSION}.tgz

      - name: Checkout gh-pages branch
        if: steps.check-version.outputs.exists == 'false'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Copy package to gh-pages
        if: steps.check-version.outputs.exists == 'false'
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"
          mkdir -p gh-pages/charts
          cp .cr-release-packages/${CHART_NAME}-${VERSION}.tgz gh-pages/charts/

      - name: Update Helm repository index
        if: steps.check-version.outputs.exists == 'false'
        run: |
          cd gh-pages
          helm repo index charts --url https://cabrera-evil.github.io/charts/charts --merge charts/index.yaml
          cp charts/index.yaml index.yaml

      - name: Commit and push to gh-pages
        if: steps.check-version.outputs.exists == 'false'
        run: |
          cd gh-pages
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add .
          git commit -m "Release ${{ matrix.name }} ${{ matrix.version }}"
          git push

      - name: Summary
        if: steps.check-version.outputs.exists == 'false'
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"
          TAG="${CHART_NAME}-${VERSION}"

          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ✅ Chart Released Successfully

          **Chart:** ${CHART_NAME}
          **Version:** ${VERSION}
          **Tag:** ${TAG}

          ### Installation

          \`\`\`bash
          helm repo add cabrera-evil https://cabrera-evil.github.io/charts/
          helm repo update
          helm install my-release cabrera-evil/${CHART_NAME} --version ${VERSION}
          \`\`\`

          ### Links

          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${TAG})
          - [Chart Repository](https://cabrera-evil.github.io/charts/)
          EOF

      - name: Already released
        if: steps.check-version.outputs.exists == 'true'
        run: |
          CHART_NAME="${{ matrix.name }}"
          VERSION="${{ matrix.version }}"

          echo "⚠️  Version $VERSION for $CHART_NAME already exists. Bump the version in ${{ matrix.path }}/Chart.yaml to trigger a new release."
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ⚠️ Version Already Released

          Chart **${CHART_NAME}** version ${VERSION} has already been released.

          To create a new release:
          1. Update the \`version\` field in \`${{ matrix.path }}/Chart.yaml\`
          2. Commit and push the changes
          EOF
