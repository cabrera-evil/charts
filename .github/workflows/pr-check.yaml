name: PR Version Check

on:
  pull_request:
    paths:
      - '*/Chart.yaml'
      - '*/values.yaml'
      - '*/templates/**'

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect modified charts
        id: detect
        run: |
          git fetch origin ${{ github.base_ref }}

          # Find all changed Chart.yaml files
          changed_charts=""
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          for file in $changed_files; do
            if [[ "$file" == */Chart.yaml ]] && [[ "$file" != *"/charts/"* ]] && [[ "$file" != *"/.github/"* ]]; then
              chart_dir=$(dirname "$file")
              chart_name=$(basename "$chart_dir")
              changed_charts="$changed_charts $chart_name:$chart_dir"
              echo "Modified chart: $chart_name at $chart_dir"
            fi
          done

          # Also detect charts with template/values changes
          for file in $changed_files; do
            if [[ "$file" == */templates/* ]] || [[ "$file" == */values.yaml ]] || [[ "$file" == */values.schema.json ]]; then
              if [[ "$file" != *"/charts/"* ]] && [[ "$file" != *"/.github/"* ]]; then
                chart_dir=$(echo "$file" | cut -d'/' -f1)
                chart_name=$(basename "$chart_dir")

                # Check if already in list
                if [[ ! "$changed_charts" =~ "$chart_name:" ]]; then
                  changed_charts="$changed_charts $chart_name:$chart_dir"
                  echo "Chart with template/values changes: $chart_name at $chart_dir"
                fi
              fi
            fi
          done

          if [ -z "$changed_charts" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No charts modified"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "charts=$changed_charts" >> "$GITHUB_OUTPUT"
            echo "Changed charts:$changed_charts"
          fi

      - name: Check version bumps
        if: steps.detect.outputs.has_changes == 'true'
        id: version-check
        run: |
          charts="${{ steps.detect.outputs.charts }}"
          git fetch origin ${{ github.base_ref }}

          all_bumped=true
          version_report=""

          for chart_info in $charts; do
            chart_name=$(echo "$chart_info" | cut -d':' -f1)
            chart_dir=$(echo "$chart_info" | cut -d':' -f2)

            echo "‚Üí Checking $chart_name..."

            # Get current version
            current_version=$(grep '^version:' "$chart_dir/Chart.yaml" | awk '{print $2}' | tr -d '"')

            # Get base version
            git show origin/${{ github.base_ref }}:"$chart_dir/Chart.yaml" > /tmp/base-chart.yaml 2>/dev/null || echo "version: 0.0.0" > /tmp/base-chart.yaml
            base_version=$(grep '^version:' /tmp/base-chart.yaml | awk '{print $2}' | tr -d '"')

            echo "  Base: $base_version"
            echo "  Current: $current_version"

            if [ "$current_version" = "$base_version" ]; then
              echo "  ‚úó Version not bumped"
              all_bumped=false
              version_report="${version_report}
          | ‚ùå **$chart_name** | $base_version | $base_version | Not bumped |"
            else
              echo "  ‚úì Version bumped"
              version_report="${version_report}
          | ‚úÖ **$chart_name** | $base_version | $current_version | Bumped |"
            fi
          done

          echo "version_report<<EOF" >> "$GITHUB_OUTPUT"
          echo "$version_report" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          if [ "$all_bumped" = "false" ]; then
            echo "all_bumped=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "all_bumped=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Post failure comment
        if: failure() && steps.version-check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `## ‚ùå Version Bump Required

            You modified chart files but didn't bump the version(s) in \`Chart.yaml\`.

            ### Chart Status

            | Chart | Base Version | PR Version | Status |
            |-------|--------------|------------|--------|
            ${{ steps.version-check.outputs.version_report }}

            ### How to Fix

            Update the version in the affected chart's \`Chart.yaml\` following SemVer:

            - **Patch** (0.2.0 ‚Üí 0.2.1): Bug fixes, minor improvements
            - **Minor** (0.2.0 ‚Üí 0.3.0): New features, backward compatible
            - **Major** (0.2.0 ‚Üí 1.0.0): Breaking changes

            \`\`\`bash
            # Edit the Chart.yaml file
            vim <chart-name>/Chart.yaml

            # Update the version field
            # version: X.Y.Z

            # Commit and push
            git add <chart-name>/Chart.yaml
            git commit -m "chore: bump <chart-name> version to X.Y.Z"
            git push
            \`\`\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Post success comment
        if: success() && steps.version-check.outputs.all_bumped == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `## ‚úÖ Chart Version Bumps Detected

            All modified charts have version bumps!

            ### Chart Status

            | Chart | Base Version | PR Version | Status |
            |-------|--------------|------------|--------|
            ${{ steps.version-check.outputs.version_report }}

            ### What Happens Next

            When this PR is merged, each chart will be automatically:
            1. üì¶ Packaged
            2. üè∑Ô∏è Tagged (e.g., \`chart-name-X.Y.Z\`)
            3. üìù Released with changelog
            4. üöÄ Published to [https://cabrera-evil.github.io/charts/](https://cabrera-evil.github.io/charts/)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Version Check Results

          ### Chart Status

          | Chart | Base Version | PR Version | Status |
          |-------|--------------|------------|--------|
          ${{ steps.version-check.outputs.version_report }}

          EOF

          if [ "${{ steps.version-check.outputs.all_bumped }}" = "true" ]; then
            echo "‚úÖ All charts have version bumps" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some charts need version bumps" >> $GITHUB_STEP_SUMMARY
          fi
