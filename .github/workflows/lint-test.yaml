name: Lint and Test Charts

on:
  pull_request:
    paths:
      - '*/Chart.yaml'
      - '*/values.yaml'
      - '*/templates/**'
      - '.github/workflows/lint-test.yaml'
  push:
    branches:
      - master
    paths:
      - '*/Chart.yaml'
      - '*/values.yaml'
      - '*/templates/**'
      - '.github/workflows/lint-test.yaml'

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run chart-testing (lint)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --check-version-increment=false

      - name: Discover all charts
        id: discover
        run: |
          charts=$(find . -maxdepth 2 -name 'Chart.yaml' -not -path '*/charts/*' -not -path '*/.github/*' | sed 's|/Chart.yaml||' | sed 's|^./||' | tr '\n' ' ')
          echo "charts=$charts" >> "$GITHUB_OUTPUT"
          echo "Discovered charts: $charts"

      - name: Lint all charts
        run: |
          charts="${{ steps.discover.outputs.charts }}"
          exit_code=0

          for chart in $charts; do
            echo "→ Linting $chart..."
            if helm lint "$chart"; then
              echo "✓ $chart passed"
            else
              echo "✗ $chart failed"
              exit_code=1
            fi
          done

          exit $exit_code

      - name: Validate Chart.yaml metadata
        run: |
          charts="${{ steps.discover.outputs.charts }}"
          exit_code=0

          for chart in $charts; do
            echo "→ Validating $chart metadata..."

            # Check required fields exist
            for field in name version appVersion description type; do
              if ! grep -q "^${field}:" "$chart/Chart.yaml"; then
                echo "✗ $chart: Missing required field: ${field}"
                exit_code=1
              fi
            done

            # Validate SemVer
            version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}' | tr -d '"')
            if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
              echo "✗ $chart: Version '$version' does not follow SemVer format"
              exit_code=1
            else
              echo "✓ $chart: All metadata valid (version: $version)"
            fi
          done

          exit $exit_code

      - name: Template all charts
        run: |
          charts="${{ steps.discover.outputs.charts }}"
          exit_code=0

          for chart in $charts; do
            echo "→ Testing template rendering for $chart..."

            # Basic template test
            if ! helm template test-release "$chart" --debug; then
              echo "✗ $chart: Basic template failed"
              exit_code=1
              continue
            fi

            # Test with common features enabled (if values exist)
            if helm template test-release "$chart" \
                --set ingress.enabled=true \
                --set autoscaling.enabled=true \
                --set podDisruptionBudget.enabled=true \
                --set networkPolicy.enabled=true \
                --set secret.enabled=true \
                --set secret.data.TEST_KEY="test-value" \
                --set configMap.enabled=true \
                --set configMap.data.TEST_CONFIG="test-config" \
                --debug 2>/dev/null; then
              echo "✓ $chart: Template rendering passed"
            else
              echo "✓ $chart: Basic template passed (optional features may not be available)"
            fi
          done

          exit $exit_code

      - name: Validate values.schema.json
        run: |
          charts="${{ steps.discover.outputs.charts }}"

          for chart in $charts; do
            if [ -f "$chart/values.schema.json" ]; then
              echo "→ Validating $chart/values.schema.json..."
              if helm template test-release "$chart" --validate; then
                echo "✓ $chart: values.schema.json is valid"
              else
                echo "✗ $chart: values.schema.json validation failed"
                exit 1
              fi
            fi
          done

      - name: Security scan with Trivy
        run: |
          charts="${{ steps.discover.outputs.charts }}"

          for chart in $charts; do
            echo "→ Scanning $chart for security issues..."
            trivy config "$chart" --severity HIGH,CRITICAL --exit-code 0
          done

      - name: Create kind cluster
        if: steps.list-changed.outputs.changed == 'true'
        uses: helm/kind-action@v1.10.0

      - name: Run chart-testing (install)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct install --target-branch ${{ github.event.repository.default_branch }}

  summary:
    runs-on: ubuntu-latest
    needs: lint-test
    if: always()
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.lint-test.result }}" != "success" ]; then
            echo "❌ Chart validation failed"
            exit 1
          else
            echo "✅ All chart validations passed"
          fi
